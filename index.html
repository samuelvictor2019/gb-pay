<!DOCTYPE html> 
<html lang="en"> 
  <head> 
    <meta charset="UTF-8"> 
    <title>Pay with Monnify</title> 
    <style> 
      body { 
        font-family: 'Poppins', sans-serif; 
        background: #f5f5f5; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        height: 100vh; } 
      .card { background: #fff; padding: 2em; 
             border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
             text-align: center; width: 320px; } 
      .amount { font-size: 2em; color: #27ae60; margin: 0.5em 0; } 
      .pay-btn { background: #27ae60; 
                color: #fff; padding: 12px 18px; 
                border: none; border-radius: 8px; 
                font-size: 1em; cursor: pointer; transition: 0.3s; } 
      .pay-btn:hover { background: #219150; } 
      footer { margin-top: 1em; font-size: 0.8em; color: #666; } 
    </style> 
  </head> 
  <body> 
    <div class="card"> 
      <h1>Hi <span id="customer-name">Customer</span> üëã</h1> 
      <p>You're about to make a payment of</p> 
      <p class="amount">‚Ç¶<span id="amount">0.00</span></p> 
      <button class="pay-btn" id="payBtn">Proceed to Pay</button> 
      <footer>Powered by ChopChat</footer> </div> 
    <!-- Monnify SDK --> 
    <script src="https://sdk.monnify.com/plugin/monnify.js"></script> 
    <script> // --- Read query parameters --- 
      const params = new URLSearchParams(window.location.search); 
      const customerName = decodeURIComponent(params.get("customer") || "Valued Customer"); 
      const customerEmail = params.get("email") || "customer@example.com"; 
      const customerPhone = params.get("phone") || "00000000000"; 
      const amount = parseFloat(params.get("amount") || "0.00"); 
      const orderId = params.get("order_id") || ""; 
      const botCallback = params.get("callback_url"); 
      // --- Update page info --- 
      document.getElementById("customer-name").textContent = customerName; 
      document.getElementById("amount").textContent = amount.toLocaleString(); 
      // --- Start Payment --- 
      document.getElementById("payBtn").addEventListener("click", () => { 
        const paymentRef = "GB_" + Math.floor(Math.random() * 1000000000); 
        // ‚úÖ Working Monnify Initialization 
        MonnifySDK.initialize({ 
          amount: amount, 
          currency: "NGN", 
          reference: paymentRef, 
          customerName: customerName, 
          customerEmail: customerEmail, 
          apiKey: "MK_TEST_B5S5KMGHNT", 
          // your test key 
          contractCode: "648444677794", 
          // your contract code 
          paymentDescription: "GroceryBazaar Order Payment", 
          isTestMode: true, // ‚úÖ Must be valid JS functions (not undefined) 
          onComplete: async function (response) { 
            console.log("‚úÖ Payment Response:", response); 
            if (response && response.paymentReference) { 
              try { 
                if (botCallback) { 
                  await fetch(botCallback, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ 
                      order_id: orderId, 
                      payment_reference: response.paymentReference, 
                      amount: amount, 
                      status: response.paymentStatus || "SUCCESS" }) }); 
                } alert("‚úÖ Payment successful! You can close this page now."); } 
              catch (err) { 
                console.error("Error sending callback:", err); } } 
            else { alert("Payment not completed. Please try again."); } }, 
          onClose: function () { 
            console.log("‚ùå Payment modal closed by user."); }, }); }); 
    </script> 

    <!-- <script>
  // Read query parameters (hosted on GitHub Pages you can pass publicKey & callback via query)
  const params = new URLSearchParams(window.location.search);
  const customerName = decodeURIComponent(params.get("customer") || "Valued Customer");
  const customerEmail = params.get("email") || "customer@example.com";
  const customerPhone = params.get("phone") || "00000000000";
  const amount = parseFloat(params.get("amount") || "0.00");
  const orderId = params.get("order_id") || "";
  const botCallback = params.get("callback_url") || ""; // MUST be public (ngrok url)
  const publicKey = params.get("public_key") || params.get("apiKey") || ""; // Monnify public key
  const contractCode = params.get("contract_code") || ""; // Monnify contract code

  document.getElementById("customer-name").textContent = customerName;
  document.getElementById("amount").textContent = amount.toLocaleString();

  // global callbacks required by some SDK versions
  window.monnifyOnComplete = function(response) {
    console.log("Monnify onComplete:", response);
    // Example response: { paymentReference: 'xxxx', paymentStatus: 'PAID', ... }
    const payload = {
      order_id: orderId,
      payment_reference: response.paymentReference || response.payment_reference || null,
      amount: amount,
      status: response.paymentStatus || 'PAID'
    };

    // POST to your Flask bot callback (must be public - use ngrok URL)
    if (botCallback) {
      fetch(botCallback, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(r => console.log("Bot callback status:", r.status)).catch(err => console.error("Bot callback error:", err));
    } else {
      console.warn("No bot callback URL provided - payment result not forwarded.");
    }

    // Optionally show success UI and then close / redirect
    alert("Payment completed. Thank you!");
    try { window.close(); } catch(e) {}
  };

  window.monnifyOnClose = function(data) {
    console.log("Monnify onClose", data);
  };

  document.getElementById("payBtn").addEventListener("click", function() {
    if (!publicKey || !contractCode) {
      alert("Payment configuration missing (publicKey/contractCode).");
      return;
    }
    if (typeof MonnifySDK === "undefined") {
      alert("Monnify SDK failed to load.");
      return;
    }

    // Use publicKey (client SDK) and contractCode only
    MonnifySDK.initialize({
      amount: amount,
      currency: "NGN",
      reference: "CK_" + Math.floor(Math.random()*100000000),
      customerName: customerName,
      customerEmail: customerEmail,
      customerMobile: customerPhone,
      publicKey: publicKey,         // client/public key
      contractCode: contractCode,   // contract code
      paymentDescription: "Order payment",
      onComplete: window.monnifyOnComplete,
      onClose: window.monnifyOnClose
    });
  });
</script> -->
  </body> 
</html>




